<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AEPL Material Requisition Form</title>
  
  <meta name="google-signin-client_id" content="631503031767-svs2t8ebq2169ruq7n7ehq5ln8ig78qd.apps.googleusercontent.com">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <style>
    body { background-color: #e9ecef; }
    .container { max-width: 1200px; }
    .item-box {
      border: 1px solid #dee2e6;
      padding: 1.25rem;
      border-radius: 10px;
      margin-bottom: 1.5rem;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .req-type-new { color: red; font-weight: bold; }
    label { font-weight: 500; }
    .required::after { content: "*"; color: red; margin-left: 2px; }
    
    /* Image Preview Style */
    .image-preview-container {
        width: 100px;
        height: 80px;
        border: 1px solid #ddd;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        margin-top: 2rem;
    }
    .image-preview {
        max-width: 100%;
        max-height: 100%;
        display: none; /* Hidden by default */
    }
    .image-preview.visible { display: block; }
    
    /* Loading Spinner */
    #loadingSpinner {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    .spinner-border { width: 3rem; height: 3rem; }
    
    /* Autocomplete highlighting */
    .ui-autocomplete .ui-menu-item strong { color: #007bff; }
  </style>
</head>
<body>

<div id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <p class="mt-2 font-weight-bold">Loading Data...</p>
</div>

<div class="container mt-4 mb-4">
  <div style="position: sticky; top: 0; background-color: #e9ecef; z-index: 1000; padding: 1rem 0;">
    <h2 class="text-center mb-3">AEPL Material Requisition Form</h2>
    <div id="auth-section" class="bg-white p-3 rounded shadow-sm">
      <div class="g_id_onload"
        data-client_id="631503031767-svs2t8ebq2169ruq7n7ehq5ln8ig78qd.apps.googleusercontent.com"
        data-context="signin"
        data-callback="handleCredentialResponse">
      </div>
      <div class="g_id_signin" data-type="standard"></div>
      
      <div id="userInfo" style="display: none;">
        <div class="form-row">
          <div class="form-group col-md-4">
            <label class="required" for="email">Email ID</label>
            <input type="email" class="form-control" id="email" name="email" readonly>
          </div>
          <div class="form-group col-md-4">
            <label class="required" for="requestee">Staff Name</label>
            <select class="form-control" id="requestee" name="requestee"></select>
          </div>
          <div class="form-group col-md-4">
            <label class="required" for="department">Department</label>
            <input type="text" class="form-control" id="department" name="department" readonly>
          </div>
        </div>
      </div>
    </div>
  </div>

  <form id="requisitionForm" style="display: none;">
    <div id="itemContainer"></div>
    <button type="submit" class="btn btn-primary btn-lg btn-block mt-3">Submit Requisition</button>
  </form>
</div>

<script>
// --- Global Variables ---
// Please double-check this URL. It must be the correct deployment URL and should NOT end with a slash (/).
const SCRIPT_URL_GET = "https://script.google.com/macros/s/AKfycbzzA73rqV7QtHo-bbr7pbW3wUAc7XkWoJSEi7XljKGb2cjCZ1MKeYzK5zaxULbB5rD9QQ/exec";
// IMPORTANT: This URL must be for the Apps Script that will RECEIVE the form data via POST.
const SCRIPT_URL_POST = "ADD_YOUR_POST_SCRIPT_URL_HERE"; 

let itemCount = 0;
let productData = [];
let employeeData = [];
let orderForData = [];

// --- Helper Functions ---
function normalize(str) {
    return str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : '';
}

function smartMatch(text, term) {
    const normText = normalize(text);
    const words = normalize(term).split(/\s+/).filter(w => w.length > 0);
    return words.every(word => normText.includes(word));
}

function highlightMatch(text, term) {
    if (!text || !term) return text;
    let newText = text;
    const words = term.split(/\s+/).filter(w => w.length > 0);
    words.forEach(word => {
        const regex = new RegExp(`(${word.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
        newText = newText.replace(regex, '<strong>$1</strong>');
    });
    return newText;
}

function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(jsonPayload);
}

// --- Authentication and Data Fetching ---
window.onload = () => {
  google.accounts.id.initialize({
    client_id: "631503031767-svs2t8ebq2169ruq7n7ehq5ln8ig78qd.apps.googleusercontent.com",
    callback: handleCredentialResponse
  });
  google.accounts.id.prompt();
};

function handleCredentialResponse(response) {
  const decoded = parseJwt(response.credential);
  document.getElementById("email").value = decoded.email;
  document.querySelector(".g_id_signin").style.display = "none";
  document.getElementById("userInfo").style.display = "block";
  fetchInitialData(decoded.email);
}

async function fetchInitialData(email) {
  try {
    const res = await fetch(SCRIPT_URL_GET);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}. Check Apps Script URL and deployment.`);
    const data = await res.json();
    if (data.error) throw new Error(data.error);
    
    productData = data.productData;
    employeeData = data.employeeData;
    orderForData = data.orderForData;

    const currentUser = employeeData.find(u => u.email === email);
    if (!currentUser) {
        alert("Unauthorized access. Your email is not registered in the employee directory.");
        document.getElementById("loadingSpinner").style.display = "none";
        return;
    }

    populateStaffDropdown(currentUser);
    document.getElementById("requisitionForm").style.display = "block";
    addItemBox();

  } catch (error) {
    console.error("Fetch error:", error);
    alert(`Failed to load initial data: ${error.message}`);
  } finally {
    document.getElementById("loadingSpinner").style.display = "none";
  }
}

function populateStaffDropdown(currentUser) {
  const select = document.getElementById("requestee");
  const deptInput = document.getElementById("department");
  select.innerHTML = "";
  employeeData.sort((a, b) => a.name.localeCompare(b.name)).forEach(user => {
    const option = document.createElement("option");
    option.value = user.name;
    option.textContent = user.name;
    option.dataset.email = user.email;
    option.dataset.department = user.department;
    select.appendChild(option);
  });
  select.value = currentUser.name;
  deptInput.value = currentUser.department;
  select.addEventListener("change", function () {
    const selected = this.options[this.selectedIndex];
    if (selected) deptInput.value = selected.dataset.department;
  });
}

// --- Dynamic Form Logic ---
function addItemBox() {
  itemCount++;
  const container = document.getElementById("itemContainer");
  const itemBox = document.createElement("div");
  itemBox.className = "item-box";
  itemBox.id = `item-box-${itemCount}`;
  const todayStr = new Date().toISOString().split("T")[0];
  itemBox.innerHTML = `<h5>Item #${itemCount}</h5><div class="form-row"><div class="form-group col-md-1"><label>UID</label><input type="text" class="form-control" name="uid_${itemCount}" readonly></div><div class="form-group col-md-4"><label class="required">Name / Description</label><input type="text" class="form-control" name="name_${itemCount}" required></div><div class="form-group col-md-1"><label>In Stock</label><input type="text" class="form-control" name="stock_${itemCount}" readonly></div><div class="form-group col-md-2"><label class="required">Quantity Req.</label><input type="number" class="form-control" name="quantity_${itemCount}" step="any" required></div><div class="form-group col-md-2"><label class="required">Unit</label><input type="text" class="form-control" name="unit_${itemCount}" required></div><div class="form-group col-md-2 d-flex justify-content-center"><div class="image-preview-container"><img class="image-preview" alt="Image"></div></div></div><div class="form-row"><div class="form-group col-md-1"><label>Type</label><input type="text" class="form-control" name="reqType_${itemCount}" readonly></div><div class="form-group col-md-2"><label>Est. Unit Price</label><input type="number" class="form-control" name="unitPrice_${itemCount}" step="any"></div><div class="form-group col-md-1"><label>GST%</label><input type="number" class="form-control" name="gst_${itemCount}" step="1"></div><div class="form-group col-md-2"><label>Est. Total Price</label><input type="text" class="form-control" name="totalPrice_${itemCount}" readonly></div><div class="form-group col-md-2"><label>Est. Total + GST</label><input type="text" class="form-control" name="totalWithGst_${itemCount}" readonly></div><div class="form-group col-md-2"><label class="required">Target Date</label><input type="date" class="form-control" name="neededBy_${itemCount}" min="${todayStr}" required></div><div class="form-group col-md-2"><label>Priority</label><br><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="priority_${itemCount}" value="Urgent"><label class="form-check-label">Urgent</label></div><div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="priority_${itemCount}" value="Normal" checked><label class="form-check-label">Normal</label></div></div></div><div class="form-row"><div class="form-group col-md-6"><label class="required">Order For (Project/Client)</label><input type="text" class="form-control" name="orderFor_${itemCount}" required></div><div class="form-group col-md-6"><label>Remarks</label><textarea class="form-control" name="remarks_${itemCount}" rows="1"></textarea></div></div><div class="form-row mt-2"><div class="form-group col-md-12 button-row d-flex justify-content-between"></div></div>`;
  container.appendChild(itemBox);
  updateItemControls();
  bindAutocomplete(itemCount);
}

function removeItemBox(button) {
  button.closest(".item-box").remove();
  document.querySelectorAll(".item-box h5").forEach((h, i) => h.textContent = `Item #${i + 1}`);
  updateItemControls();
}

function updateItemControls() {
  const boxes = document.querySelectorAll(".item-box");
  boxes.forEach((box, idx) => {
    const row = box.querySelector('.button-row');
    row.innerHTML = '';
    if (boxes.length > 1) {
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-outline-danger';
      removeBtn.innerText = '− Remove Item';
      removeBtn.onclick = () => removeItemBox(removeBtn);
      row.appendChild(removeBtn);
    }
    if (idx === boxes.length - 1) {
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = 'btn btn-outline-primary ml-auto';
      addBtn.innerText = '+ Add Another Item';
      addBtn.onclick = addItemBox;
      row.appendChild(addBtn);
    }
  });
}

// --- Autocomplete and Calculations ---
function calculateTotals(index) {
  const box = $(`#item-box-${index}`);
  const qty = parseFloat(box.find(`[name='quantity_${index}']`).val()) || 0;
  const price = parseFloat(box.find(`[name='unitPrice_${index}']`).val()) || 0;
  const gst = parseFloat(box.find(`[name='gst_${index}']`).val()) || 0;
  const total = qty * price;
  const totalWithGst = total * (1 + (gst / 100));
  box.find(`[name='totalPrice_${index}']`).val(total.toFixed(2));
  box.find(`[name='totalWithGst_${index}']`).val(totalWithGst.toFixed(2));
}

function bindAutocomplete(index) {
  const nameInput = $(`#item-box-${index} [name='name_${index}']`);
  const orderInput = $(`#item-box-${index} [name='orderFor_${index}']`);
  const box = $(`#item-box-${index}`);

  nameInput.autocomplete({
    source: (request, response) => {
      const matches = productData.filter(i => smartMatch(i.Name, request.term));
      response(matches.map(i => ({ label: i.Name, value: i.Name, item: i })));
    },
    select: (event, ui) => {
      event.preventDefault();
      const item = ui.item.item;
      box.find(`[name='uid_${index}']`).val(item.UID);
      box.find(`[name='name_${index}']`).val(item.Name);
      box.find(`[name='stock_${index}']`).val(item.Stock);
      box.find(`[name='unit_${index}']`).val(item.Unit);
      box.find(`[name='unitPrice_${index}']`).val(item.UnitPrice);
      box.find(`[name='gst_${index}']`).val(item.GST);
      box.find(`[name='reqType_${index}']`).val('Repeat').removeClass('req-type-new');
      const imgPreview = box.find('.image-preview');
      if (item.ImageLink && item.ImageLink.includes('drive.google.com')) {
        const idMatch = item.ImageLink.match(/\/d\/([a-zA-Z0-9_-]+)/);
        if (idMatch) imgPreview.attr('src', 'https://drive.google.com/thumbnail?id=' + idMatch[1]).addClass('visible');
      } else {
        imgPreview.attr('src', '').removeClass('visible');
      }
      calculateTotals(index);
      return false;
    },
    change: (event, ui) => {
      if (!ui.item) {
        box.find(`[name='reqType_${index}']`).val('New').addClass('req-type-new');
        box.find(`[name='uid_${index}']`).val('');
        box.find(`[name='stock_${index}']`).val('');
        box.find('.image-preview').attr('src', '').removeClass('visible');
      }
    }
  }).autocomplete("instance")._renderItem = function(ul, item) {
    // This is the updated render function that adds highlighting
    const highlightedLabel = highlightMatch(item.label, this.term);
    return $("<li>")
      .append(`<div>${highlightedLabel}<br><small>UID: ${item.item.UID} | Stock: ${item.item.Stock}</small></div>`)
      .appendTo(ul);
  };

  orderInput.autocomplete({ source: orderForData });

  box.find(`[name='quantity_${index}']`).on('input', () => calculateTotals(index));
  box.find(`[name='unitPrice_${index}']`).on('input', () => calculateTotals(index));
  box.find(`[name='gst_${index}']`).on('input', () => calculateTotals(index));
}

// --- Form Submission ---
document.getElementById("requisitionForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const submitBtn = this.querySelector("button[type='submit']");
  let isValid = true;
  let validationErrors = [];
  document.querySelectorAll(".item-box").forEach((box, i) => {
      const index = i + 1;
      const name = box.querySelector(`[name='name_${index}']`).value.trim();
      const quantity = parseFloat(box.querySelector(`[name='quantity_${index}']`).value);
      const unit = box.querySelector(`[name='unit_${index}']`).value.trim();
      const neededBy = box.querySelector(`[name='neededBy_${index}']`).value;
      const orderFor = box.querySelector(`[name='orderFor_${index}']`).value.trim();
      if (!name) { validationErrors.push(`Item #${index}: Name/Description is required.`); isValid = false; }
      if (isNaN(quantity) || quantity <= 0) { validationErrors.push(`Item #${index}: Quantity must be a number greater than 0.`); isValid = false; }
      if (!unit) { validationErrors.push(`Item #${index}: Unit is required.`); isValid = false; }
      if (!neededBy) { validationErrors.push(`Item #${index}: Target Date is required.`); isValid = false; }
      if (!orderFor) { validationErrors.push(`Item #${index}: 'Order For' is required.`); isValid = false; }
  });
  if (!isValid) {
      alert("Please fix the following errors:\n\n" + validationErrors.join("\n"));
      return;
  }
  submitBtn.disabled = true;
  submitBtn.innerText = "Submitting...";
  const formData = new FormData(this);
  const email = document.getElementById("email").value;
  const requestee = document.getElementById("requestee").value;
  const department = document.getElementById("department").value;
  formData.append('header_email', email);
  formData.append('header_requestee', requestee);
  formData.append('header_department', department);
  fetch(SCRIPT_URL_POST, { method: "POST", body: formData })
    .then(response => response.text())
    .then(text => {
      if (text.trim().toLowerCase() === "success") {
        alert("Requisition submitted successfully!");
        window.location.reload();
      } else {
        throw new Error(text);
      }
    })
    .catch(error => {
      console.error("Submission error:", error);
      alert(`Submission failed. Please check the console for details or try again.\n\nError: ${error.message}`);
      submitBtn.disabled = false;
      submitBtn.innerText = "Submit Requisition";
    });
});
</script>
</body>
</html>
